# -*- coding: utf-8 -*-
"""Fundamental.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NLVhGgXuXnLKKrPqp0lwgC-ilnKNgAc1
"""
import streamlit as st
import pandas as pd
import requests
import matplotlib.pyplot as plt
import seaborn as sns
def get_financial_data(stock_symbol):
    urls = {
        "income_statement": f"https://stockanalysis.com/quote/psx/{stock_symbol}/financials/",
        "balance_sheet": f"https://stockanalysis.com/quote/psx/{stock_symbol}/financials/balance-sheet/",
        "cash_flow": f"https://stockanalysis.com/quote/psx/{stock_symbol}/financials/cash-flow-statement/",
        "ratios": f"https://stockanalysis.com/quote/psx/{stock_symbol}/financials/ratios/"
    }

    data = {}

    for key, url in urls.items():
        try:
            # Set headers to mimic a browser
          headers = {
                  'User -Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'
            }

          # Make the request with headers
          response = requests.get(url, headers=headers)
          data[key] = pd.read_html(response.text)[0]
          # dropping the second header
          data[key].columns = data[key].columns.droplevel(1)

          # transpose the dataframe and reset the column
          data[key] = data[key].T
          data[key].columns = data[key].iloc[0]
          data[key] = data[key][1:]

          # Cleaning the data (for converting object data to numeric)
          # Find all columns where '%' sign is present
          percent_columns = [col for col in data[key].columns if data[key][col].astype(object).str.contains('%').any()]

          # Add '%' sign to column names
          data[key].rename(columns={col: f"{col} (%)" for col in percent_columns}, inplace=True)

          # dropping last row that contains "Upgrade" in all columns
          data[key].drop(index = data[key].index[-1], axis = 0, inplace = True)

          # replacing empty data with 0
          data[key].replace('-', '0', inplace=True)

          # replacing % with ''
          data[key] = data[key].replace('%', '', regex=True)
          data[key].head()

          data[key] = data[key].astype(float)
          data[key]['Year'] = ['TTM', '2024', '2023', '2022', '2021', '2020']
          data[key].head()
        except Exception as e:
             print(f"Error retrieving data from {url}: {e}")
        # data['income_statement']['Year'] = ['TTM', '2024', '2023', '2022', '2021', '2020']
        # data['balance_sheet']['Year'] = ['TTM', '2024', '2023', '2022', '2021', '2020']
        # data['cash_flow']['Year'] = ['TTM', '2024', '2023', '2022', '2021', '2020']
        # data['ratios']['Year'] = ['TTM', '2024', '2023', '2022', '2021', '2020']
    return data

# this function will create default plots and user input plots
def plot_dataframe(data):
    # plotting important metrics
    income_metrics = ['Revenue', 'Revenue Growth (YoY) (%)', 'Gross Margin (%)', 'Operating Margin (%)',	'Profit Margin (%)', 'Interest Expense']
    balance_metrics = ['Cash & Equivalents', 'Property, Plant & Equipment', 'Long-Term Debt', 'Retained Earnings', 'Book Value Per Share']
    cash_metrics = ['Free Cash Flow', 'Free Cash Flow Per Share']
    ratio_metrics = ['Debt / Equity Ratio', 'Current Ratio',	'Return on Equity (ROE) (%)',	'Return on Assets (ROA) (%)',	'Return on Capital (ROIC) (%)']

    for key, df in data.items():
        print(f"Available columns in {key}: {df.columns.tolist()}")
        if key == 'income_statement':
            for metric in income_metrics:
                if metric in df.columns:
                  sns.barplot(data=df, x='Year', y=metric)
                  plt.title(f"{metric} over Years")
                  plt.xlabel('Year')
                  plt.ylabel(metric)
                  plt.xticks(rotation=45)
                  plt.tight_layout()
                  plt.show()
        print(f"Available columns in {key}: {df.columns.tolist()}")
        if key == 'balance_sheet':
            for metric in balance_metrics:
                if metric in df.columns:
                  sns.barplot(data=df, x='Year', y=metric)
                  plt.title(f"{metric} over Years")
                  plt.xlabel('Year')
                  plt.ylabel(metric)
                  plt.xticks(rotation=45)
                  plt.tight_layout()
                  plt.show()
        print(f"Available columns in {key}: {df.columns.tolist()}")
        if key == 'cash_flow':
            for metric in cash_metrics:
                if metric in df.columns:
                  sns.barplot(data=df, x='Year', y=metric)
                  plt.title(f"{metric} over Years")
                  plt.xlabel('Year')
                  plt.ylabel(metric)
                  plt.xticks(rotation=45)
                  plt.tight_layout()
                  plt.show()
        print(f"Available columns in {key}: {df.columns.tolist()}")
        if key == 'ratios':
            for metric in balance_metrics:
                if metric in df.columns:
                  sns.barplot(data=df, x='Year', y=metric)
                  plt.title(f"{metric} over Years")
                  plt.xlabel('Year')
                  plt.ylabel(metric)
                  plt.xticks(rotation=45)
                  plt.tight_layout()
                  plt.show()

    # Get user input for DataFrame and column
    df_key = input("Enter the DataFrame key (income_statement, balance_sheet, cash_flow, ratios): ")
    df = data[df_key]
    metric = input(f"Enter the column name from {df_key} to plot: ")
    if metric in df.columns:
      # Create a plot
      sns.barplot(data=df, x='Year', y=metric)
      plt.title(f"{metric} over Years")
      plt.xlabel('Year')
      plt.ylabel(metric)
# plot_dataframe(data)

# Function to calculate Gordon Growth Model (GGM) valuation
def gordon_growth_model(D1, r, g):
    if r <= g:
        return "Required return must be greater than the growth rate."
    return D1 / (r - g)

# Function to calculate Discounted Cash Flow (DCF) valuation
def discounted_cash_flow_valuation(recent_free_cash_flow, growth_rate, discount_rate):
    projected_cash_flows = []
    # Project cash flows for the next 5 years
    for year in range(1, 6):
        future_cash_flow = recent_free_cash_flow * ((1 + growth_rate) ** year)
        present_value = future_cash_flow / ((1 + discount_rate) ** year)
        projected_cash_flows.append(present_value)

    # Sum the present values of projected cash flows to get the fair value
    fair_value = sum(projected_cash_flows)
    return fair_value

# Function to calculate PEG Ratio
def peg_ratio(pe, g):
    if g == 0:
        return "Growth rate cannot be zero."
    return pe / g

"""## Main Program"""

# Main program to take user input stocks
list_of_stocks = ['786', 'AABS', 'AAL', 'AASM', 'AATM', 'ABL', 'ABOT', 'ABSON', 'ACPL', 'ADAMS', 'ADMM', 'AGHA', 'AGIC', 'AGIL', 'AGL', 'AGLNCPS', 'AGP', 'AGSML', 'AGTL', 'AHCL', 'AHL', 'AHTM', 'AICL', 'AIRLINK', 'AKBL', 'AKDHL', 'AKDSL', 'AKGL', 'ALAC', 'ALIFE', 'ALNRS', 'ALTN', 'AMBL', 'AMSL', 'AMTEX', 'ANL', 'ANLNV', 'ANLPS', 'ANNT', 'ANSM', 'ANTM', 'APL', 'APOT', 'ARCTM', 'ARPAK', 'ARPL', 'ARUJ', 'ASC', 'ASHT', 'ASIC', 'ASL', 'ASLCPS', 'ASLPS', 'ASTL', 'ASTM', 'ATBA', 'ATIL', 'ATLH', 'ATRL', 'AVN', 'AWTX', 'AZMT', 'BAFL', 'BAFS', 'BAHL', 'BAPL', 'BATA', 'BBFL', 'BCL', 'BECO', 'BELA', 'BERG', 'BFBIO', 'BFMOD', 'BGL', 'BHAT', 'BIFO', 'BIIC', 'BILF', 'BIPL', 'BML', 'BNL', 'BNWM', 'BOK', 'BOP', 'BPL', 'BRRG', 'BTL', 'BUXL', 'BWCL', 'BWHL', 'CASH', 'CCM', 'CENI', 'CEPB', 'CFL', 'CHAS', 'CHBL', 'CHCC', 'CJPL', 'CLCPS', 'CLOV', 'CLVL', 'CNERGY', 'COLG', 'CPHL', 'CPPL', 'CRTM', 'CSAP', 'CSIL', 'CTM', 'CWSM', 'CYAN', 'DAAG', 'DADX', 'DAWH', 'DBCI', 'DBSL', 'DCL', 'DCR', 'DCTL', 'DEL', 'DFML', 'DFSM', 'DGKC', 'DIIL', 'DINT', 'DKTM', 'DLL', 'DMTM', 'DMTX', 'DNCC', 'DOL', 'DSFL', 'DSIL', 'DSL', 'DSML', 'DWAE', 'DWSM', 'DWTM', 'DYNO', 'ECOP', 'EFERT', 'EFGH', 'EFUG', 'EFUL', 'ELCM', 'ELSM', 'EMCO', 'ENGL', 'ENGRO', 'EPCL', 'EPCLPS', 'EPQL', 'ESBL', 'EWIC', 'EXIDE', 'FABL', 'FAEL', 'FANM', 'FASM', 'FATIMA', 'FCCL', 'FCEL', 'FCEPL', 'FCIBL', 'FCL', 'FCONM', 'FCSC', 'FDPL', 'FECM', 'FECTC', 'FEM', 'FEROZ', 'FFBL', 'FFC', 'FFL', 'FFLM', 'FHAM', 'FIBLM', 'FIL', 'FIM', 'FIMM', 'FLYNG', 'FML', 'FNBM', 'FNEL', 'FPJM', 'FPRM', 'FRCL', 'FRSM', 'FSWL', 'FTHM', 'FTMM', 'FTSM', 'FZCM', 'GADT', 'GAL', 'GAMON', 'GATI', 'GATM', 'GCIL', 'GEMBCEM', 'GEMBLUEX', 'GEMMEL', 'GEMPAPL', 'GEMSPNL', 'GFIL', 'GGGL', 'GGL', 'GHGL', 'GHNI', 'GIL', 'GLAXO', 'GLOT', 'GLPL', 'GOC', 'GRR', 'GRYL', 'GSPM', 'GTYR', 'GUSM', 'GUTM', 'GVGL', 'GWLC', 'HABSM', 'HADC', 'HAEL', 'HAFL', 'HAJT', 'HALEON', 'HASCOL', 'HATM', 'HBL', 'HCAR', 'HCL', 'HGFA', 'HICL', 'HIFA', 'HINO', 'HINOON', 'HIRAT', 'HKKT', 'HMB', 'HMIM', 'HPL', 'HRPL', 'HSPI', 'HTL', 'HUBC', 'HUMNL', 'HUSI', 'HWQS', 'IBFL', 'IBLHL', 'ICCI', 'ICIBL', 'ICL', 'IDRT', 'IDSM', 'IDYM', 'IGIHL', 'IGIL', 'ILP', 'IMAGE', 'IML', 'INDU', 'INIL', 'INKL', 'INMF', 'IPAK', 'ISIL', 'ISL', 'ITTEFAQ', 'JATM', 'JDMT', 'JDWS', 'JGICL', 'JKSM', 'JLICL', 'JSBL', 'JSCL', 'JSCLPSA', 'JSGCL', 'JSIL', 'JSML', 'JUBS', 'JVDC', 'JVDCPS', 'KAKL', 'KAPCO', 'KCL', 'KEL', 'KHTC', 'KHYT', 'KML', 'KOHC', 'KOHE', 'KOHP', 'KOHTM', 'KOIL', 'KOSM', 'KPUS', 'KSBP', 'KSTM', 'KTML', 'LCI', 'LEUL', 'LMSM', 'LOADS', 'LOTCHEM', 'LPGL', 'LPL', 'LSECL', 'LSEFSL', 'LSEVL', 'LUCK', 'MACFL', 'MACTER', 'MARI', 'MCB', 'MCBIM', 'MDTL', 'MEBL', 'MEHT', 'MERIT', 'MFFL', 'MFL', 'MFTM', 'MIRKS', 'MLCF', 'MOHE', 'MQTM', 'MRNS', 'MSCL', 'MSOT', 'MSOTPS', 'MTL', 'MUBT', 'MUGHAL', 'MUREB', 'MWMP', 'NAFL', 'NAGC', 'NATF', 'NATM', 'NBP', 'NCL', 'NCML', 'NCPL', 'NESTLE', 'NETSOL', 'NEXT', 'NICL', 'NINA', 'NMFL', 'NML', 'NONS', 'NPL', 'NRL', 'NRSL', 'NSRM', 'OBOY', 'OCTOPUS', 'OGDC', 'OLPL', 'OLPM', 'OML', 'ORM', 'OTSU', 'PABC', 'PACE', 'PAEL', 'PAKD', 'PAKL', 'PAKOXY', 'PAKRI', 'PAKT', 'PASL', 'PASM', 'PCAL', 'PECO', 'PELPS', 'PGLC', 'PHDL', 'PIAHCLA', 'PIAHCLB', 'PIBTL', 'PICL', 'PICT', 'PIL', 'PIM', 'PINL', 'PIOC', 'PKGI', 'PKGP', 'PKGS', 'PMI', 'PMPK', 'PMRS', 'PNSC', 'POL', 'POML', 'POWER', 'POWERPS', 'PPL', 'PPP', 'PPVC', 'PREMA', 'PRET', 'PRIB', 'PRIC', 'PRL', 'PRWM', 'PSEL', 'PSO', 'PSX', 'PSYL', 'PTC', 'PTL', 'PUDF', 'QUET', 'QUICE', 'RCML', 'REDCO', 'REGAL', 'REWM', 'RICL', 'RMPL', 'RPL', 'RUBY', 'RUPL', 'SAIF', 'SANE', 'SANSM', 'SAPT', 'SARC', 'SASML', 'SAZEW', 'SBL', 'SCBPL', 'SCL', 'SDOT', 'SEARL', 'SEL', 'SEPL', 'SERT', 'SFAT', 'SFL', 'SGABL', 'SGF', 'SGPL', 'SHCI', 'SHCM', 'SHDT', 'SHEL', 'SHEZ', 'SHFA', 'SHJS', 'SHNI', 'SHSML', 'SIBL', 'SICL', 'SIEM', 'SILK', 'SINDM', 'SITC', 'SKRS', 'SLCL', 'SLCPA', 'SLGL', 'SLL', 'SLYT', 'SMCPL', 'SML', 'SNAI', 'SNBL', 'SNGP', 'SPEL', 'SPL', 'SPLC', 'SPWL', 'SRVI', 'SSGC', 'SSIC', 'SSML', 'SSOM', 'STCL', 'STJT', 'STML', 'STPL', 'STYLERS', 'SUHJ', 'SURAJ', 'SURC', 'SUTM', 'SYM', 'SYS', 'SZTM', 'TAJT', 'TATM', 'TBL', 'TCORP', 'TCORPCPS', 'TELE', 'TGL', 'THALL', 'THCCL', 'TICL', 'TOMCL', 'TOWL', 'TPL', 'TPLI', 'TPLP', 'TPLRF1', 'TPLT', 'TREET', 'TRG', 'TRIBL', 'TRIPF', 'TRSM', 'TSBL', 'TSMF', 'TSML', 'TSPL', 'UBDL', 'UBL', 'UCAPM', 'UDLI', 'UDPL', 'UNIC', 'UNITY', 'UPFL', 'USMT', 'UVIC', 'WAHN', 'WAVES', 'WAVESAPP', 'WTL', 'YOUW', 'ZAHID', 'ZELP', 'ZHCM', 'ZIL', 'ZTL']
stock_symbol = input("Enter stock symbol (e.g., TOMCL for The Organic Meat Company): ")  # Take stock symbol as input from user

# Fetch stock data using def get_financial_data(stock_symbol):
if stock_symbol in list_of_stocks:
  data = get_financial_data(stock_symbol)
else:
  print("Invalid Stock Symbol")

# Creating Visualization
plot_dataframe(data)

# Select valuation method
print("\nSelect Valuation Method:")
print("1. Gordon Growth Model (GGM)")
print("2. Discounted Cash Flow (DCF)")
print("3. PEG Ratio")
method = int(input("Enter your choice (1, 2, or 3): "))

# Initialize Variables for each Method
if method == 1:  # Gordon Growth Model (GGM)
    print("\n--- Gordon Growth Model (GGM) ---")
    # User input for Dividend and required return rate
    dividend = float(input("Enter expected dividend next year (PKR): "))  # User input
    growth_rate_ggm = float(input("Enter dividend growth rate (%): ")) / 100  # User input
    required_rate = float(input("Enter required rate of return (%): ")) / 100  # User input

    # Calculation
    fair_value_ggm = gordon_growth_model(dividend, required_rate, growth_rate_ggm)
    print(f"Fair value using GGM: {fair_value_ggm}")

elif method == 2:  # Discounted Cash Flow (DCF)
    print("\n--- Discounted Cash Flow (DCF) ---")
    # Calculation for DCF using fetched data
    # growth rate is equal to average book value per share growth rate
    bvps = data['balance_sheet']['Book Value Per Share'].iloc[1:][::-1]
    bvps_growth = (bvps.pct_change()*100).mean()
    print(f'{bvps_growth:.2f} %')

    # getting expected growth rate from user
    growth_rate = float(input(f"Enter growth rate in %. The avg book value growth rate is {bvps_growth} %"))
    discount_rate = float(input("Enter discount rate in %. The default rate is 15 % "))

    # free cash flow per share for 2024
    free_cash_flow = data['cash_flow']['Free Cash Flow Per Share'].iloc[1]

    fcf = discounted_cash_flow_valuation(free_cash_flow, growth_rate = bvps_growth/100, discount_rate = discount_rate/100)
    # Multiply the fcf with average P/E ratio to get the fair value
    pe_ratio = data['ratios']['PE Ratio'].iloc[1:].mean()
    fcf *= pe_ratio
    print(f"Fair value using DCF: PKR{fcf:,.2f}")

elif method == 3:  # PEG Ratio
    print("\n--- PEG Ratio ---")
    print("PEG value less than 1 indicated a undervalued stock while PEG value greater than 1 indicates a overvalued stock")
    # Calculation for PEG Ratio using fetched data
    pe_ratio = data['ratios']['PE Ratio'].iloc[1].mean()
    bvps = data['balance_sheet']['Book Value Per Share'].iloc[1:][::-1]
    bvps_growth = (bvps.pct_change()*100).mean()
    growth_rate = float(input(f"Enter growth rate in %. The avg book value growth rate is {bvps_growth} "))
    peg_val = peg_ratio(pe_ratio, growth_rate)
    print(f"PEG Ratio: {peg_val}")

else:
    print("Invalid choice. Please select a valid option (1, 2, or 3).")

